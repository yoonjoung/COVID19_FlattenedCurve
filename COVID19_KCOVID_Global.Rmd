---
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
---
```{r intro, echo=FALSE, results="hide"}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE, 
                      comment = "", 
                      warning=FALSE, 
                      results="hide") 
knitr::opts_knit$set(root.dir = "~/Dropbox/0 Project/COVID19_SOuthKorea/")

date<-as.Date(Sys.time(	), format='%d%b%Y')
time<-Sys.time()

suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(ggplot2)))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(readxl)))
suppressWarnings(suppressMessages(library(plotly)))
suppressWarnings(suppressMessages(library(Matrix)))
suppressWarnings(suppressMessages(library(stringr)))
suppressWarnings(suppressMessages(library(stringi)))
suppressWarnings(suppressMessages(library(readxl)))
suppressWarnings(suppressMessages(library(lubridate)))
suppressWarnings(suppressMessages(library(zoo)))
```

```{r dtaPop}
#estimates:Total population, both sexes combined, as of 1 July (thousands)
dtapop<-read_excel("~/Dropbox/0 Project/COVID19_SouthKorea/WPP2019/WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES.xlsx")

dtapop<-dtapop%>%
    rename(country = "Region, subregion, country or area *",
           pop = "2020")%>%
    filter(Type=="Country/Area")%>%
    select(country, pop, region)%>%
    mutate(pop=as.numeric(pop))

```

```{r dtaCOVID}
url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"
dtacases<-read.csv(url)%>%
    rename(country = Country.Region,
           region = Province.State)%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           cases = value)%>%
    select(country, date, cases)%>%
    mutate(country=as.character(country))%>%
    group_by(country, date)%>%
    summarize_all(funs(sum))%>%ungroup()

url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"
dtadeaths<-read.csv(url)%>%
    rename(country = Country.Region,
           region = Province.State)%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           deaths = value)%>%
    select(country, date, deaths)%>%
    mutate(country=as.character(country))%>%
    group_by(country, date)%>%
    summarize_all(funs(sum))%>%ungroup()

str(dtacases)
str(dtadeaths)

dtacovid<-left_join(dtacases, dtadeaths, by = c("country", "date"))%>%
    mutate(date=mdy(substring(date, 2)) )

dim(dtacases)
dim(dtadeaths)
dim(dtacovid)

#prep for join/merge
dtacovid<-dtacovid%>%
    mutate(
        country=ifelse(country=="Bolivia","Bolivia (Plurinational State of)", country),
        country=ifelse(country=="Brunei","Brunei Darussalam", country),
        country=ifelse(country=="Burma","Myanmar", country),
        country=ifelse(country=="Congo (Brazzaville)","Congo", country),
        country=ifelse(country=="Congo (Kinshasa)","Democratic Republic of the Congo", country),
        country=ifelse(country=="Cote d'Ivoire","C?te d'Ivoire", country),
        country=ifelse(country=="Iran","Iran (Islamic Republic of)", country),
        country=ifelse(country=="Korea, South","Republic of Korea", country),
        country=ifelse(country=="Laos","Lao People's Democratic Republic", country),
        country=ifelse(country=="Moldova","Republic of Moldova", country),
        country=ifelse(country=="Russia","Russian Federation", country), 
        country=ifelse(country=="Syria","Syrian Arab Republic", country),
        country=ifelse(country=="Taiwan*","China, Taiwan Province of China", country),      
        country=ifelse(country=="Tanzania","United Republic of Tanzania", country),   
        country=ifelse(country=="US","United States of America", country),
        country=ifelse(country=="Venezuela","Venezuela (Bolivarian Republic of)", country),     
        country=ifelse(country=="Vietnam","Viet Nam", country),
        country=ifelse(country=="West Bank and Gaza","State of Palestine", country)
        )
```

```{r dta}
str(dtacovid)
str(dtapop)

dta<-full_join(dtacovid, dtapop, by = "country")

dim(dtacovid)
dim(dtapop)
dim(dta)


temp<-dta%>%filter(is.na(pop)==TRUE) 
#table(temp$country) #countries without pop

temp<-dta%>%filter(is.na(cases)==TRUE)
#table(temp$country) #countries without COVID data 

dta<-dta%>%arrange(country, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(country!=lag(country), NA, newcases),

        newdeaths=deaths-lag(deaths),
        newdeaths=ifelse(country!=lag(country), NA, newdeaths),
        
        incidence=round(100000*cases/(pop*1000), 1), # confirmed cases per 100,000 pop
        cfr=round(100*deaths/cases, 1), # deaths per 100 confirmed cases   
        mortality=round(100000*deaths/(pop*1000), 1) # deaths per 100000 pop
    )%>%arrange(country, date)%>%
    mutate(
        newcasessmooth =c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 
        newdeathssmooth=c(NA,NA,NA,NA,NA,NA,rollmean(newdeaths, 7)), 
        newcasessmooth=ifelse(country!=lag(country), NA, newcasessmooth),
        newdeathssmooth=ifelse(country!=lag(country), NA, newdeathssmooth),
        newcasessmooth =round(newcasessmooth, 3),  
        newdeathssmooth=round(newdeathssmooth, 3),

        newcasessmoothpp=round(100*newcasessmooth/pop, 3),   
        newdeathssmoothpp=round(100*newdeathssmooth/pop, 3),
        
        oecd=(country=="Australia"
		| country=="Austria"
		| country=="Belgium"
		| country=="Canada"
		| country=="Chile"
		| country=="Czechia"
		| country=="Denmark"
		| country=="Estonia"
		| country=="Finland"
		| country=="France"
		| country=="Germany"
		| country=="Greece"
		| country=="Hungary"
		| country=="Iceland"
		| country=="Ireland"
		| country=="Israel"
		| country=="Italy"
		| country=="Japan"
		| country=="Latvia"
		| country=="Lithuania"
		| country=="Luxembourg"
		| country=="Mexico"
		| country=="Netherlands"
		| country=="New Zealand"
		| country=="Norway"
		| country=="Poland"
		| country=="Portugal"
		| country=="Slovakia"
		| country=="Slovenia"
		| country=="Republic of Korea"
		| country=="Spain"
		| country=="Sweden"
		| country=="Switzerland"
		| country=="Turkey"
		| country=="United Kingdom"
		| country=="United States of America"), 
		
		country=ifelse(country=="Republic of Korea", "South Korea", country),
		country=ifelse(country=="China, Taiwan Province of China", "Taiwan", country),
		country=ifelse(country=="United States of America", "United States", country)
		
		)

temp<-dta%>%filter(oecd==TRUE)
#table(temp$country) # OECD countries 
length(unique(temp$country))

#data quality problem: cumulative deaths and cases going down in some cases 
    
    summary(dta$newcases)
    summary(dta$newdeaths)
    temp<-dta%>%filter(newcases<0 | newdeaths<0)
    dim(temp)
    head(temp, nrow(temp))
    
    temp<-dta%>%filter(newcasessmooth<0 | newdeathssmooth<0)
    dim(temp)
    head(temp, nrow(temp))    

#Force negative smooth numbers to 0 

dta<-dta%>%
    mutate(
        newcasessmooth   =ifelse(newcasessmooth<0,    0, newcasessmooth),
        newcasessmoothpp =ifelse(newcasessmoothpp<0,  0, newcasessmoothpp),
        newdeathssmooth  =ifelse(newdeathssmooth<0,   0, newdeathssmooth),
        newdeathssmoothpp=ifelse(newdeathssmoothpp<0, 0, newdeathssmoothpp)
    )

```


```{r}
temp<-dta%>%filter(country!="China")%>%
    group_by(date)%>% 
    mutate(
        topcases=max(cases), 
        top=cases==topcases)%>% 
    ungroup()%>%
    filter(top==TRUE)%>%
    select(date, cases, country)%>%
    filter(country=="South Korea")
    
```    

```{r dtacurve}
dtacurve<-dta%>%filter(oecd==TRUE)%>%filter(date>="2020-02-01")
    
    length(unique(dta$country))
    length(unique(dtacurve$country))

dtacurve<-dtacurve%>%
    arrange(country, date)%>%
    group_by(country)%>%
    mutate(
        day = row_number(),
        maxday = max(day),
        latestmonth= maxday-day<=30, 
        newcasessmoothpplatestmonth = newcasessmoothpp,
        newcasessmoothpplatestmonth = ifelse(latestmonth!=1, NA,
                                             newcasessmoothpplatestmonth), 
                
        latest=date==max(date), 
        
        startdate=min(date),
        startcases=newcasessmooth,
            startcases=ifelse(date!=startdate, NA, startcases), 
        startcasespp=round(100*startcases/pop, 1))%>%
    fill(startcases, startcasespp)%>%
    fill(startcases, startcasespp, .direction = "up")%>%
    mutate(
        peakcases=max(newcasessmooth, na.rm = TRUE),
        peakcasespp=round(100*peakcases/pop, 1),
        peakdate=as.character(date),
            peakdate=ifelse(peakcases!=newcasessmooth, "", peakdate),
            peakdate=ymd(substring(peakdate, 1)) )%>%
    fill(peakdate)%>%
    fill(peakdate, .direction = "up")%>%
    mutate(
        endcases=newcasessmooth,
            endcases=ifelse(date<=peakdate, NA, endcases), 
            endcases=ifelse(newcasessmooth>startcases, NA, endcases),
        enddate=as.character(date),
            enddate=ifelse(is.na(endcases)==TRUE, "", enddate),
            enddate=ifelse(is.na(lag(endcases))==FALSE & is.na(endcases)==FALSE, "", enddate),
            enddate=ymd(substring(enddate, 1)))%>%
    fill(enddate)%>%
    fill(enddate, .direction = "up")%>%
    mutate(
        latestcasespp=newcasessmoothpp, 
        latestcasespp=ifelse(latest==FALSE, NA, latestcasespp),
        latestlevel=round((latestcasespp-startcasespp)/(peakcasespp-startcasespp), 3)
        )%>%
    fill(latestlevel)%>%
    fill(latestlevel, .direction = "up")%>%
    fill(latestcasespp)%>%
    fill(latestcasespp, .direction = "up")%>%    
    ungroup()%>%
    select(country, oecd, date, day, latest, cases, deaths, pop,  incidence, cfr, mortality, starts_with("new"), starts_with("start"), starts_with("peak"), starts_with("end"), starts_with("latest"), -endcases)

dtacurve<-dtacurve%>%
    mutate(latestcasespp=round(ifelse(latest==FALSE, NA, latestcasespp), 1),
           incidence=round(incidence, 0),
           mortality=round(mortality, 0))
```


#### __COVID-19 waves: comparative perspectives among high-resource settings__  

<div class="alert alert-info">
__NOTE__   
Since July 2, 2022, select data from this site have been presented in __[an interactive app](https://isquared.shinyapps.io/COVID19_OECD)__. This site is not maintained regularly anymore.
</div>

(Last updated on `r time`. Published on November 13, 2020. An earlier version, _"The flattened COVID-19 curve in South Korea - and comparative perspectives among high-resource settings"_, was published at [Medium](https://medium.com/@yj.choi.isquared/flattening-covid-19-curve-in-south-korea-and-comparison-among-oecd-countries-singapore-and-taiwan-ae211a5645c9))

More than 10 months after the first reported COVID-19 case, the epidemic has hit countries around the globe with different intensity at different time. Some countries like Taiwan has managed to avoid major outbreaks all together, some have controlled outbreaks relatively effectively (e.g., New Zealand and South Korea), but many have had a substantial outbreak, often followed by another.  

A clear lesson so far is no country is safe from the pandemic:    

* After impressive initial success in preventing the epidemic, Singapore has experienced [substantial outbreaks among vulnerable groups in the country](https://www.npr.org/sections/coronavirus-live-updates/2020/04/20/838324209/singapore-sees-surge-in-covid-19-cases-now-has-highest-number-in-southeast-asia).   
* Eastern European countries [avoided the epidemic in Spring](https://www.theguardian.com/world/2020/may/05/why-has-eastern-europe-suffered-less-from-coronavirus-than-the-west) but [later faced major outbreaks](https://abcnews.go.com/International/eastern-europe-largely-avoided-coronavirus-1st-wave-now/story?id=73674366).    
* Frustratingly, though not unexpected, bigger second wave of transmission have affected many - even in high-resource countries that have controlled the first wave, which seemed insurmountable back then.       

We will compare epidemic curves among the Organisation for Economic Co-operation and Development (OECD) member countries. Understanding different epidemic curves to date will help us hopefully address the current crisis and more importantly prevent, delay, and flatten the next waves.  

_Hover over each figure to see values and more options_.  

_See data sources and methods at the end_.  

#### __1. Latest snapshot by country__

Before we check the epidemic curve to date, let's briefly compare __cumulative incidence__ (number of reported cases per 100,000 population) and __cumulative mortality rates__ (number of reported COVID-19 deaths per 100,000 population). Considering different testing rates, COVID-19 specific mortality rate per population (right panel) may be more appropriate to compare across countries.   

```{r plotincidence, fig.align="left", out.width="800px"}

dtafig<-dtacurve%>%
    filter(oecd==TRUE)%>%
    filter(latest==TRUE)     

#write.csv(dtafig, "KCOVID/dtaKCOVIDsummary.csv")

dtafig$country<-factor(dtafig$country, 
                    levels = unique(dtafig$country) 
                    [order(dtafig$incidence, decreasing = FALSE)])

colorvector<-c(
    'lightgray','lightgray','lightgray','lightgray','lightgray',
    'lightgray','lightgray','lightgray','lightgray','lightgray',
    'lightgray','lightgray','lightgray','lightgray','lightgray',
    'lightgray','lightgray','lightgray','lightgray','lightgray',
    'lightgray','#9FE8C5','lightgray','lightgray','lightgray',
    'lightgray','lightgray','lightgray','lightgray','#9FC5E8',
    'lightgray','lightgray','lightgray','lightgray','lightgray','#878787')

colorlist<- list(color = colorvector)

figincidence<-
    plot_ly(dtafig, 
            y=~country, x=~incidence, type = 'bar', orientation="h",
            name= "country", marker=colorlist,
            text = ~incidence, textposition = 'outside')%>%
    layout(
            yaxis = list(
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle= 0),
            xaxis = list(title = "Cumulative cases/100,000 population", showgrid=FALSE) 
            )

figincidence
```

```{r plotmortality, fig.align="left", out.width="800px"}


dtafig$country<-factor(dtafig$country, 
                    levels = unique(dtafig$country) 
                    [order(dtafig$mortality, decreasing = FALSE)])

figmortality<-
    plot_ly(dtafig, y=~country, x=~mortality, type = 'bar',
            orientation="h",
            name= "country", marker=colorlist,
            text = ~mortality, textposition = 'outside')%>%
    layout(
            yaxis = list(
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=0),
            xaxis = list(title = "Cumulative deaths/100,000 population", showgrid=FALSE) 
            )

figmortality
```

```{r plotnewcases, fig.align="left", out.width="800px"}
colorvector<-c(
    '#EADCD1','#EADCD1','#EADCD1','#EADCD1','#EADCD1',
    '#EADCD1','#EADCD1','#EADCD1','#EADCD1','#EADCD1',
    '#EADCD1','#EADCD1','#EADCD1','#EADCD1','#EADCD1',
    '#EADCD1','#EADCD1','#EADCD1','#EADCD1','#EADCD1',
    '#EADCD1','#9FE8C5','#EADCD1','#EADCD1','#EADCD1',
    '#EADCD1','#EADCD1','#EADCD1','#EADCD1','#9FC5E8',
    '#EADCD1','#EADCD1','#EADCD1','#EADCD1','#EADCD1','#878787')

colorlist<- list(color = colorvector)

dtafig$country<-factor(dtafig$country, 
                    levels = unique(dtafig$country) 
                    [order(dtafig$latestcasespp, decreasing = FALSE)])

fignewcases<-
    plot_ly(dtafig, y=~country, x=~latestcasespp, type = 'bar',
            orientation="h",
            name= "country", marker=colorlist,
            text = ~latestcasespp, textposition = 'outside')%>%
    layout(
            yaxis = list(
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=0),
            xaxis = list(title = "Daily new cases/100,000 population", showgrid=FALSE) 
            )

fignewcases
```

```{r plotincidencemortality, results="asis", fig.align="left", out.width="800px"}

subplot(figincidence, figmortality, shareX=TRUE, shareY = FALSE, margin=0.05)%>%
    layout(showlegend=FALSE,
           title="Cumulative COVID-19 cases vs. deaths", 
           xaxis = list(showticklabels = TRUE, tickfont = list(size=8), tickangle=-90))
```

And, cumulative incidence vs. __new daily cases__ (7-day rolling average of daily new reported cases per 100,000 population): New daily cases (right panel) shows the current burden of transmission. 
```{r plotcumulativenewcases, results="asis", fig.align="left", out.width="800px"}

subplot(figincidence, fignewcases, shareX=TRUE, shareY = FALSE, margin=0.05)%>%
    layout(showlegend=FALSE,
           title="Cumulative vs. daily new COVID-19 cases", 
           xaxis = list(showticklabels = TRUE, tickfont = list(size=8), tickangle=-90))
```

```{r plotcfr, fig.align="left", out.width="800px"}

dtafig$country<-factor(dtafig$country, 
                    levels = unique(dtafig$country) 
                    [order(dtafig$cfr, decreasing = TRUE)])

figcfr<-plot_ly(dtafig, x=~country, y=~cfr, type = 'bar',
              name= "country", marker=colorlist)%>%
    layout(
            title = c("COVID-19 deaths per 100 confirmed cases"),     
            xaxis = list(
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Case fatality rate (%)") 
            )
figcfr
```

#### __2. Epidemic curve by country__

The below shows trends of __7-day rolling averages of daily new cases per 100,000 population__ since February, 2020. 

All countries are presented below in groups, due to varying range of peak height. Top panel has countries with relatively lower peak, and the bottom panel shows countries with higher peak.

Note:  
* The x-axis is date since February.    
* The y-axis is 7-day rolling average of daily new cases per 100,000 population.   
* `The light gray box` represents the number of daily new cases 20 or lower per 100,000.     
* <span style="color: #195F90;">The darker blue section of the line</span> represents the last 30 days.    

```{r plotpanel, fig.align="left", out.width="300px", out.height="200px"}
mindate<-min(dtafig$date)
maxdate<-max(dtafig$date)

panel <- . %>% 
    plot_ly(x = ~date)%>% 
    add_trace(
        y = 0.1, type = 'scatter', mode = 'lines',
        line= list(color = "#F1F1F1") ) %>%    
    add_trace(
        y = 20, type = 'scatter', mode = 'lines',
        fill = 'tonexty',fillcolor='#EEEEEE', opacity=0.1,
        line= list(color = "#F1F1F1") ) %>%    
    add_trace(
        y = ~newcasessmoothpp, type = 'scatter', mode = 'lines',
        line= list(color = "#70A8CF"),  
        hoverinfo = 'text',
        text = ~paste('</br> Date: ', date,
                      '</br> New cases per 100,000: ', newcasessmoothpp)) %>%
    add_trace(
        y = ~newcasessmoothpplatestmonth, type = 'scatter', mode = 'lines',
        line= list(color = "#195F90") ) %>%
    add_trace(
        y = ~latestcasespp, type = 'scatter', mode = 'markers',
        marker = list(size = 5,color ="#195F90"),
        text = ~latestcasespp, 
        textfont=list(size=10, color="#195F90"), 
        textposition = "bottom left"
        )%>%       
    add_annotations(
        text = ~unique(country),
        x = 0.5,
        y = 0.8,
        xref = "paper",
        yref = "paper",    
        xanchor = "center", yanchor = "bottom", 
        showarrow = FALSE,
        font = list(size = 10) ) %>%
    layout(
        showlegend = FALSE,
        title = c(""),
        xaxis=list(range=c(mindate, maxdate), showgrid = FALSE, 
                    autotick = TRUE,
                    tickfont = list(size=10), 
                    tickangle= 45), 
        yaxis=list(range=c(0,maxy), title="", showgrid = FALSE) 
        )
```

```{r plotSKunlike1, results="asis", fig.align="left", out.width="800px", out.height="200px", eval=FALSE}

dtafig<-dtacurve%>%
    filter(oecd==TRUE)%>%
    filter(peakcasespp<20)%>%
    mutate(latestcasespp=round(latestcasespp, 0))
    
nobs<-ceiling(length(unique(dtafig$country))/4)
maxy<-max(dtafig$newcasessmoothpp)

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    add_trace(
        y = 0.45, type = 'scatter', mode = 'lines',
        line= list(color = "#F1F1F1")  ) %>%    
    subplot(nrows = nobs, shareX = TRUE, shareY = TRUE)        
```

```{r plotSKunlike2, results="asis", fig.align="left", out.width="800px", out.height="200px"}

dtafig<-dtacurve%>%
    filter(oecd==TRUE)%>%
    filter(peakcasespp>=20 & peakcasespp<100)%>%
    mutate(latestcasespp=round(latestcasespp, 0))

nobs<-ceiling(length(unique(dtafig$country))/4)
maxy<-max(dtafig$newcasessmoothpp)

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = nobs, shareX = TRUE, shareY = TRUE)        
```

```{r plotSKunlike3, results="asis", fig.align="left", out.width="800px", out.height="400px"}

dtafig<-dtacurve%>%
    filter(oecd==TRUE)%>%
    filter(peakcasespp>=100 & peakcasespp<200)%>%
    mutate(latestcasespp=round(latestcasespp, 0))

nobs<-ceiling(length(unique(dtafig$country))/4)

mindate<-min(dtafig$date)
maxdate<-max(dtafig$date)
maxy<-max(dtafig$newcasessmoothpp)

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = nobs, shareX = TRUE, shareY = TRUE)        
```

```{r plotSKunlike4, results="asis", fig.align="left", out.width="800px", out.height="600px"}

dtafig<-dtacurve%>%
    filter(oecd==TRUE)%>%
    filter(peakcasespp>=200 & peakcasespp<400)%>%
    mutate(latestcasespp=round(latestcasespp, 0))

nobs<-ceiling(length(unique(dtafig$country))/4)

mindate<-min(dtafig$date)
maxdate<-max(dtafig$date)
maxy<-max(dtafig$newcasessmoothpp)

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = nobs, shareX = TRUE, shareY = TRUE)        
```

```{r plotSKunlike5, results="asis", fig.align="left", out.width="800px", out.height="600px"}

dtafig<-dtacurve%>%
    filter(oecd==TRUE)%>%
    filter(peakcasespp>=400 & peakcasespp<600)%>%
    mutate(latestcasespp=round(latestcasespp, 0))

nobs<-ceiling(length(unique(dtafig$country))/4)

mindate<-min(dtafig$date)
maxdate<-max(dtafig$date)
maxy<-max(dtafig$newcasessmoothpp)

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = nobs, shareX = TRUE, shareY = TRUE)        
```

```{r plotSKunlike6, results="asis", fig.align="left", out.width="800px", out.height="400px"}

dtafig<-dtacurve%>%
    filter(oecd==TRUE)%>%
    filter(peakcasespp>=600)%>%
    mutate(latestcasespp=round(latestcasespp, 0))

nobs<-ceiling(length(unique(dtafig$country))/4)

mindate<-min(dtafig$date)
maxdate<-max(dtafig$date)
maxy<-max(dtafig$newcasessmoothpp)

dtafig%>%
    group_by(country) %>%
    do(p = panel(.)) %>%
    subplot(nrows = nobs, shareX = TRUE, shareY = TRUE)        
```

---

__METHODS__  

__Data__  
1. All COVID-19 data (i.e., cumulative confirmed cases and deaths by day) come from [JHU/CSSE](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data). Accessed on `r date`.    
2. All data on country population come from UN [World Population Prospects 2019 Revision](https://population.un.org/wpp/). Accessed on April 18, 2020.   

Note on comparability: JHU/CSSE compiles the best available data, but a definition of confirmed cases (even COVID-19 deaths) may differ across countries and even within a country over time. The abrupt increase in the number of new cases in France, for example, likely reflect changes in the definition of confirmed cases. 

__Measures__
The number of new confirmed cases on each date was calculated based on the difference between cumulative numbers over two consecutive days. Then, a seven-day rolling average was calculated, hereinafter referred to as the _smoothed_ number of new confirmed cases. Then, the smoothed number was divided by the total population in the country: _the smoothed number of new confirmed cases per 100,000 population_.

---

<p style="color:gray">
See [GitHub](https://github.com/yoonjoung/COVID19_FlattenedCurve) for data, code, and more information. 
For typos, errors, and questions, contact me at [www.isquared.global](https://www.iSquared.global/YJ). 

_Making Data Delicious, One Byte at a Time_, in good times and bad times.</p>